<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>backtest strategy manager</title>
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 0.875rem;
            /* 14px */
        }

        h4 {
            font-size: 1.125rem;
            /* 18px */
        }

        #parameter-editor {
            margin-top: 20px;
        }

        #backtest-results {
            margin-top: 40px;
        }

        .strategy-item {
            cursor: pointer;
            padding: 8px;
        }

        .strategy-item:hover {
            background: #f5f5f5;
        }

        /* 新增选中高亮样式 */
        .strategy-item.active {
            background: #0d6efd;
            color: white;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 左侧区域 -->
            <div class="col-md-3 border-end pe-4">
                <div class="mb-4">
                    <h4>strategy list</h4>
                    <div id="strategy-list" class="mb-4"></div>
                </div>

                <div id="parameter-editor">
                    <h4>strategy parameters</h4>
                    <div id="params-form"></div>
                </div>

                <button id="run-backtest" class="btn btn-primary mt-3 w-100">run backtest</button>
            </div>

            <!-- 右侧区域 -->
            <div class="col-md-9">
                <h4>backtest history</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>name</th>
                                <th>param</th>
                                <th>exec time</th>
                                <th>report</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- 动态填充回测记录 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 加载策略列表
        async function loadStrategies() {
            const res = await fetch('/api/strategies');
            const data = await res.json();

            const listEl = document.getElementById('strategy-list');
            listEl.innerHTML = data.strategies.map(x =>
                `<div class="strategy-item" data-name="${x.name}">${x.name}</div>`
            ).join('');

            // 添加点击事件
            document.querySelectorAll('.strategy-item').forEach(item => {
                item.addEventListener('click', () => {
                    // 移除所有项的选中状态
                    document.querySelectorAll('.strategy-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    // 为当前点击项添加选中状态
                    item.classList.add('active');
                    loadStrategyParams(item.dataset.name);

                    // 加载并显示该策略的历史回测记录
                    loadStrategyHistory(item.dataset.name);
                });
            });
        }

        // 加载策略参数表单
        async function loadStrategyParams(strategyName) {
            // 动态获取参数配置
            const res = await fetch(`/api/strategies/${strategyName}/params`);
            const data = await res.json();

            const formEl = document.getElementById('params-form');
            formEl.innerHTML = `
                <h5>${strategyName}</h5>
                ${data.params}
            `;

            // 设置当前策略
            window.currentStrategy = strategyName;
        }
        // ... existing code ...

        // 加载策略的历史回测记录
        async function loadStrategyHistory(strategyName) {
            try {
                const res = await fetch(`/api/records?strategies_name=${strategyName}`);
                const data = await res.json();

                const tbody = document.getElementById('history-table-body');

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center">no history record</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(record => `
                    <tr>
                        <td>${record.result_id}</td>
                        <td>${record.strategy_name}</td>
                        <td>${JSON.stringify(record.params)}</td>
                        <td>${new Date(record.timestamp).toLocaleString()}</td>
                        <td>
                            <a href="${record.report_path}" target="_blank" class="btn btn-sm btn-outline-primary">bt_report</a>
                            <a href="${record.pf_report_path}" target="_blank" class="btn btn-sm btn-outline-primary">pf_report</a>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('load history failed:', error);
                document.getElementById('history-table-body').innerHTML =
                    `<tr><td colspan="4" class="text-center text-danger">load history failed</td></tr>`;
            }
        }

        // 执行回测
        document.getElementById('run-backtest').addEventListener('click', async () => {
            if (!window.currentStrategy) {
                alert('please select a strategy first!');
                return;
            }

            // 动态获取表单参数
            const formEl = document.getElementById('params-form');
            const inputs = formEl.querySelectorAll('input');
            const params = {};
            inputs.forEach(input => {
                if (input.type === 'number') {
                    params[input.name] = parseInt(input.value);
                } else if (input.type === 'checkbox') {
                    params[input.name] = input.checked;
                } else {
                    params[input.name] = input.value;
                }
            });

            console.log('params', params);

            const res = await fetch('/api/backtest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    strategy_name: window.currentStrategy,
                    params: params
                })
            });

            const result = await res.json();

            alert('backtest success!');

            // 刷新当前策略的历史记录列表
            loadStrategyHistory(window.currentStrategy);
        });

        // 初始化
        loadStrategies();
    </script>
</body>

</html>